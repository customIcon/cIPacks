name: Build and Deploy Packs

on:
  push:
    branches: [ main ]
    paths:
      - "packFolder/**"

env:
  packsStoreFile: "cIPacksStore.json"

jobs:
  build_pack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "14.x"

      - name: Install Dependencies
        run: |
          cd packFolder
          npm install

      - name: Find pushed directory
        id: find_dir
        run: |
          echo "::set-output name=dir::$(find packFolder -type d -name 'cI.*' -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2 | xargs basename)"

      - name: Get pack data
        id: pack_data
        run: |
          echo "::set-output name=packdata::$(jq -r ".[] | select(.name == \"${{ needs.build_pack.outputs.name }}\") | {name: .name, description: .description, author: .pack_maker, icon_author: .author, filename: \"${{ needs.build_pack.outputs.name }}.cIPack\"}" ${env.packsStoreFile})"
        shell: bash

      - name: Zip and move pack folder
        working-directory: packFolder
        run: |
          echo "$zipname $name"
          zip -r "$zipname" "$name" -i "*"
          mv "$zipname" ../packs/
        env:
          zipname: "$name.cIPack"
          name: "${{ steps.find_dir.outputs.dir }}"

      - name: Append pack data to packs store
        id: append_data
        run: |
          packname="${{ steps.find_dir.outputs.dir }}"
          manifest_file="packFolder/$packname/cIManifest.json"
          pack_author=$(jq -r '.pack_author' "$manifest_file")
          icon_author=$(jq -r '.maker' "$manifest_file")
          description=$(jq -r '.description' "$manifest_file")
          pack_file="$packname.cIPack"
          new_data="{\"name\":\"$packname\",\"description\":\"$description\",\"author\":\"$pack_author\",\"icon_author\":\"$icon_author\",\"filename\":\"$pack_file\"}"
          echo "$new_data" >> "$GITHUB_WORKSPACE/$env.packsStoreFile"
        env:
          packsStoreFile: ${{ env.packsStoreFile }}

      - name: Set up packDir environment variable
        run: echo "packDir=/packDir" >> $GITHUB_ENV
      
      - name: Move pack directory
        run: |
          mv $packname "${{ env.packDir }}"
